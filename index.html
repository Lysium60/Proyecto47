<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de archivos</title>
    <!--Bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!--Iconos bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <!--Estilos externos-->
    <link href="styleconstant.css" rel="stylesheet">
    <link href="stylemarkdown.css" rel="stylesheet">
    <!-- SortableJS para arrastrar y soltar -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <!-- JSZip para crear archivos ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <!--JS constante y JS de  creador blogs-->
    <script src="javascriptconstant.js"></script>
    <script src="jscreateblogs.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            background: linear-gradient(to bottom, black, blue);
            height: 100%;
            /* Asegura que el degradado cubra toda la altura de la pantalla */
            margin: 0;
            /* Elimina los márgenes predeterminados del cuerpo */
            overflow-x: hidden;
        }
    </style>
</head>

<body>
    <div id="chatSidebar" class="chat-sidebar">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom border-secondary">
            <h5 class="mb-0">Chat</h5>
        </div>
        <div id="chatMessages" class="chat-messages p-3">
            <!-- Los mensajes del chat se insertarán aquí -->
        </div>
        <div class="chat-input">
            <div class="input-group">
                <input type="text" id="messageInput" class="form-control bg-dark text-white"
                    placeholder="Escribe un mensaje...">
                <button class="btn btn-outline-secondary text-white" type="button" id="voiceInputBtn">
                    <i class="bi bi-mic"></i>
                </button>
                <button class="btn btn-outline-secondary text-white" type="button" id="sendMessageBtn">
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="mainContent" class="main-content">
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <a class="navbar-brand" href="index.html"><img class="rounded-circle" alt="Logo" src="logo.png"
                        style="width: 75px; height: 75px;"></a>
                </ul>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item mx-3">
                            <a class="nav-link text-light" href="index.html">Gestor de archivos</a>
                        </li>
                        <li class="nav-item mx-3">
                            <a class="nav-link text-light" href="classroom1.html">Classroom</a>
                        </li>
                        <li class="nav-item mx-3">
                            <a class="nav-link text-light" href="#">Materias/Notas</a>
                        </li>
                        <li class="nav-item mx-3">
                            <a class="nav-link text-light " href="view-blogs.html">Tus Blogs</a>
                        </li>
                    </ul>
                    <div class="d-flex">
                        <button class="btn btn-outline-secondary me-2">
                            <i class="bi bi-bell"></i>
                        </button>
                        <button class="btn btn-outline-secondary me-2">
                            <i class="bi bi-upload"></i>
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="userDropdown"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-person"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li><a class="dropdown-item" href="#">Perfil</a></li>
                                <li><a class="dropdown-item" href="#">Configuración</a></li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item" href="login.html">Cerrar sesión</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
        <main class="container-fluid mt-4">
            <div class="container m-3">
                <div class="card m-3" style="background-color: rgb(255, 255, 255, 0.15);">
                    <div class="card-body">
                        <h2 class="card-title text-light">Documentos</h2>
                        <div class="container mt-5">
                            <!-- Botones principales -->
                            <div class="d-flex justify-content-center mb-4">
                                <button id="saveButton" class="btn btn-primary me-2" aria-label="Guardar Mapa"
                                    data-bs-toggle="tooltip" title="Guardar Mapa">
                                    <i class="fas fa-save"></i> Guardar Mapa
                                </button>
                                <button id="exportButton" class="btn btn-success me-2" aria-label="Exportar a Markdown"
                                    data-bs-toggle="tooltip" title="Exportar a Markdown">
                                    <i class="fas fa-file-export"></i> Exportar a Markdown
                                </button>
                                <button id="resetButton" class="btn btn-danger" aria-label="Reiniciar Mapa"
                                    data-bs-toggle="tooltip" title="Reiniciar Mapa">
                                    <i class="fas fa-trash-alt"></i> Reiniciar Mapa
                                </button>
                            </div>

                            <!-- Contenedor principal del mapa mental -->
                            <div id="mindMap" class="border p-3" role="tree" aria-label="Mapa Mental">
                                <!-- El mapa mental se generará aquí dinámicamente -->
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <div class="container m-3">
                <div class="card m-3 " style="background-color: rgb(255, 255, 255, 0.15);">
                    <div class="card-body">
                        <h2 class="mb-4 text-center text-light">Gestor de Blogs</h2>
                        <!-- Navegación de pestañas -->
                        <h2 class="text-light">Crear Nuevo Blog</h2>
                        <form id="postForm" class="mt-4">
                            <div class="mb-3">
                                <label for="title" class="form-label text-light">Título</label>
                                <input type="text" class="form-control" id="title" required>
                            </div>
                            <div class="mb-3">
                                <label for="content" class="form-label text-light">Contenido</label>
                                <textarea class="form-control" id="content" rows="5" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="file" class="form-label text-light">Archivo adjunto</label>
                                <input type="file" class="form-control" id="file">
                            </div>
                            <button type="submit" class="btn btn-primary">Publicar</button>
                            <a href="view-blogs.html" class="btn btn-outline-danger">Cancelar</a>
                        </form>
                    </div>
                    <script>
                        const postForm = document.getElementById('postForm');
                        const title = document.getElementById('title');
                        const content = document.getElementById('content');
                        const file = document.getElementById('file');

                        postForm.addEventListener('submit', (e) => {
                            e.preventDefault();

                            let posts = JSON.parse(localStorage.getItem('posts')) || [];

                            const post = {
                                title: title.value,
                                content: content.value,
                                createdAt: new Date().toISOString()
                            };

                            const savePost = () => {
                                posts.push(post);
                                localStorage.setItem('posts', JSON.stringify(posts));
                                alert('Post guardado exitosamente!');
                                window.location.href = 'view-blogs.html';
                            };

                            if (file.files[0]) {
                                const reader = new FileReader();
                                reader.onload = function (event) {
                                    post.fileName = file.files[0].name;
                                    post.fileType = file.files[0].type;
                                    post.fileSize = file.files[0].size;
                                    post.fileData = event.target.result;
                                    savePost();
                                };
                                reader.readAsDataURL(file.files[0]);
                            } else {
                                savePost();
                            }
                        });
                    </script>
                </div>
            </div>
        </main>
    </div>
    <script>
        // Definición de la estructura de un nodo
        class Node {
            constructor(id, content) {
                this.id = id;
                this.content = content;
                this.children = [];
                this.style = {
                    bold: false,
                    italic: false,
                    underline: false,
                    color: '#000000'
                };
                this.link = null;
                this.collapsed = false;
                this.files = []; // Almacena objetos File
            }
        }

        // Clase principal para manejar el mapa mental
        class MindMap {
            constructor() {
                this.rootNode = new Node(0, 'Archivos');
                this.render();
                this.setupEventListeners();
                this.setupTooltips();
            }

            // Renderiza todo el mapa mental
            render() {
                const mindMapContainer = document.getElementById('mindMap');
                mindMapContainer.innerHTML = this.renderNode(this.rootNode);
                this.setupSortable(mindMapContainer);
            }

            // Renderiza un nodo individual y sus hijos
            renderNode(node) {
                let html = `
                                      
                                     <div class="node ${node.collapsed ? 'collapsed' : ''}" id="node-${node.id}" role="treeitem" aria-expanded="${!node.collapsed}">
                                     <div class="node-content">
                    <span class="drag-handle" aria-hidden="true"><i class="fas fa-grip-vertical"></i></span>
                    <span class="me-2" style="${this.getNodeStyle(node)}">${node.content}</span>
                    <div class="node-buttons">
                        <input type="text" class="form-control form-control-sm me-2" placeholder="Nueva idea" style="max-width: 150px;" aria-label="Nueva idea">
                        <button class="btn btn-sm btn-outline-primary" onclick="mindMap.addChild(${node.id})" aria-label="Añadir hijo" data-bs-toggle="tooltip" title="Añadir hijo">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="mindMap.removeNode(${node.id})" aria-label="Eliminar nodo" data-bs-toggle="tooltip" title="Eliminar nodo">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="mindMap.editNode(${node.id})" aria-label="Editar nodo" data-bs-toggle="tooltip" title="Editar nodo">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="mindMap.toggleStyle(${node.id}, 'bold')" aria-label="Alternar negrita" data-bs-toggle="tooltip" title="Alternar negrita">
                            <i class="bi bi-type-bold"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="mindMap.toggleStyle(${node.id}, 'italic')" aria-label="Alternar cursiva" data-bs-toggle="tooltip" title="Alternar cursiva">
                            <i class="bi bi-type-italic"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="mindMap.toggleStyle(${node.id}, 'underline')" aria-label="Alternar subrayado" data-bs-toggle="tooltip" title="Alternar subrayado">
                            <i class="bi bi-type-underline"></i>
                        </button>
                        <input type="color" class="color-picker" value="${node.style.color}" onchange="mindMap.changeColor(${node.id}, this.value)" aria-label="Cambiar color" data-bs-toggle="tooltip" title="Cambiar color">
                        <button class="btn btn-sm btn-outline-primary" onclick="mindMap.addLink(${node.id})" aria-label="Añadir enlace" data-bs-toggle="tooltip" title="Añadir enlace">
                            <i class="bi bi-link-45deg"></i>
                        </button>
                        <input type="file" id="files-${node.id}" class="d-none" multiple onchange="mindMap.handleFileUpload(${node.id}, this.files)">
                        <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('files-${node.id}').click()" aria-label="Subir archivos" data-bs-toggle="tooltip" title="Subir archivos">
                            <i class="bi bi-upload"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="mindMap.toggleCollapse(${node.id})" aria-label="Colapsar/Expandir" data-bs-toggle="tooltip" title="Colapsar/Expandir">
                            <i class="bi ${node.collapsed ? 'bi-plus-lg' : 'bi-dash-lg'}"></i>
                        </button>
                    </div>
                </div>
                ${this.renderFileList(node)}
                <div class="children">
                    ${node.children.map(child => this.renderNode(child)).join('')}
                </div>
            </div>
        `;
                return html;
            }

            // Renderiza la lista de archivos adjuntos
            renderFileList(node) {
                if (node.files.length === 0) return '';
                let fileListHtml = '<div class="file-list">';
                for (let file of node.files) {
                    fileListHtml += `<span class="file-item">${file.name}</span>`;
                }
                fileListHtml += '</div>';
                return fileListHtml;
            }

            // Configura Sortable para permitir arrastrar y soltar
            setupSortable(container) {
                new Sortable(container, {
                    group: 'nested',
                    animation: 150,
                    fallbackOnBody: true,
                    swapThreshold: 0.65,
                    handle: '.drag-handle',
                    onEnd: (evt) => {
                        this.updateNodeStructure(evt.from, evt.to, evt.oldIndex, evt.newIndex);
                    }
                });

                container.querySelectorAll('.children').forEach(el => {
                    new Sortable(el, {
                        group: 'nested',
                        animation: 150,
                        fallbackOnBody: true,
                        swapThreshold: 0.65,
                        handle: '.drag-handle',
                        onEnd: (evt) => {
                            this.updateNodeStructure(evt.from, evt.to, evt.oldIndex, evt.newIndex);
                        }
                    });
                });
            }

            // Actualiza la estructura de nodos después de arrastrar y soltar
            updateNodeStructure(fromEl, toEl, oldIndex, newIndex) {
                const fromNodeId = fromEl.closest('.node').id.split('-')[1];
                const toNodeId = toEl.closest('.node').id.split('-')[1];
                const fromNode = this.findNode(this.rootNode, parseInt(fromNodeId));
                const toNode = this.findNode(this.rootNode, parseInt(toNodeId));

                if (fromNode && toNode) {
                    const [movedNode] = fromNode.children.splice(oldIndex, 1);
                    toNode.children.splice(newIndex, 0, movedNode);
                    this.render();
                }
            }

            // Obtiene los estilos CSS para un nodo
            getNodeStyle(node) {
                return `
            font-weight: ${node.style.bold ? 'bold' : 'normal'};
            font-style: ${node.style.italic ? 'italic' : 'normal'};
            text-decoration: ${node.style.underline ? 'underline' : 'none'};
            color: ${node.style.color};
        `;
            }

            // Añade un nuevo nodo hijo
            addChild(parentId) {
                const parentNode = this.findNode(this.rootNode, parentId);
                if (parentNode) {
                    const newContent = document.querySelector(`#node-${parentId} input[type="text"]`).value;
                    if (newContent) {
                        const newNode = new Node(Date.now(), newContent);
                        parentNode.children.push(newNode);
                        this.render();
                    }
                }
            }

            // Elimina un nodo
            removeNode(id) {
                if (id === 0) return; // No permitir eliminar el nodo raíz
                if (confirm('¿Estás seguro de que quieres eliminar este nodo y todos sus hijos?')) {
                    this.rootNode = this.removeNodeRecursive(this.rootNode, id);
                    this.render();
                }
            }

            removeNodeRecursive(node, id) {
                node.children = node.children.filter(child => child.id !== id);
                node.children = node.children.map(child => this.removeNodeRecursive(child, id));
                return node;
            }

            // Edita el contenido de un nodo
            editNode(id) {
                const node = this.findNode(this.rootNode, id);
                if (node) {
                    const newContent = prompt('Editar nodo:', node.content);
                    if (newContent !== null) {
                        node.content = newContent;
                        this.render();
                    }
                }
            }

            // Cambia los estilos de un nodo (negrita, cursiva, subrayado)
            toggleStyle(id, style) {
                const node = this.findNode(this.rootNode, id);
                if (node) {
                    node.style[style] = !node.style[style];
                    this.render();
                }
            }

            // Cambia el color de un nodo
            changeColor(id, color) {
                const node = this.findNode(this.rootNode, id);
                if (node) {
                    node.style.color = color;
                    this.render();
                }
            }

            // Añade un enlace a un nodo
            addLink(id) {
                const node = this.findNode(this.rootNode, id);
                if (node) {
                    const link = prompt('Añadir enlace:', node.link || '');
                    if (link !== null) {
                        node.link = link || null;
                        this.render();
                    }
                }
            }

            // Maneja la subida de múltiples archivos
            handleFileUpload(id, files) {
                const node = this.findNode(this.rootNode, id);
                if (node) {
                    node.files = [...node.files, ...Array.from(files)];
                    this.render();
                }
            }

            // Colapsa o expande un nodo
            toggleCollapse(id) {
                const node = this.findNode(this.rootNode, id);
                if (node) {
                    node.collapsed = !node.collapsed;
                    this.render();
                }
            }

            // Busca un nodo por su ID
            findNode(node, id) {
                if (node.id === id) return node;
                for (let child of node.children) {
                    const found = this.findNode(child, id);
                    if (found) return found;
                }
                return null;
            }

            // Guarda el mapa mental en localStorage
            save() {
                const saveData = JSON.stringify(this.rootNode);
                localStorage.setItem('mindMap', saveData);
                alert('Mapa mental guardado!');
            }

            // Carga el mapa mental desde localStorage
            load() {
                const savedMap = localStorage.getItem('mindMap');
                if (savedMap) {
                    this.rootNode = JSON.parse(savedMap);
                    this.render();
                }
            }

            // Reinicia el mapa mental
            reset() {
                if (confirm('¿Estás seguro de que quieres reiniciar el mapa mental? Se perderán todos los datos.')) {
                    this.rootNode = new Node(0, 'Idea Principal');
                    localStorage.removeItem('mindMap');
                    this.render();
                }
            }

            // Exporta el mapa mental a formato Markdown
            async exportToMarkdown() {
                const folderName = prompt('Ingrese el nombre de la carpeta para guardar los archivos:', 'mi_mapa_mental');
                if (!folderName) return;

                const zip = new JSZip();
                const folder = zip.folder(folderName);
                let markdown = await this.generateMarkdown(this.rootNode, folder, folderName);
                folder.file('mapa-mental.md', markdown);

                const content = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(content);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${folderName}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert(`
            Mapa mental exportado con éxito.
            Instrucciones:
            1. Descomprime el archivo ${folderName}.zip
            2. Abre la carpeta ${folderName}
            3. Abre el archivo mapa-mental.md con un visor de Markdown
            4. Los archivos adjuntos están en la misma carpeta y pueden ser abiertos directamente desde los enlaces en el Markdown
            5. Asegúrate de mantener todos los archivos en la misma carpeta para que los enlaces funcionen correctamente
            6. Si usas Visual Studio Code, instala la extensión "Markdown Preview Enhanced" para una mejor visualización
        `);
            }

            // Genera el Markdown para un nodo y sus hijos
            async generateMarkdown(node, folder, folderName, level = 0) {
                let markdown = '  '.repeat(level) + '- ';

                if (node.style.bold) markdown += '**';
                if (node.style.italic) markdown += '_';
                if (node.style.underline) markdown += '<u>';

                markdown += node.link ? `[${node.content}](${node.link})` : node.content;

                if (node.style.underline) markdown += '</u>';
                if (node.style.italic) markdown += '_';
                if (node.style.bold) markdown += '**';

                if (node.style.color !== '#000000') {
                    markdown += ` <span style="color: ${node.style.color}">■</span>`;
                }

                if (node.files.length > 0) {
                    markdown += '\n' + '  '.repeat(level + 1) + 'Archivos adjuntos:\n';
                    for (let file of node.files) {
                        const safeFileName = this.getSafeFileName(file.name);
                        await folder.file(safeFileName, file, { binary: true });
                        markdown += '  '.repeat(level + 2) + `- [${file.name}](./${encodeURIComponent(safeFileName)})\n`;
                    }
                }

                markdown += '\n';

                if (!node.collapsed) {
                    for (let child of node.children) {
                        markdown += await this.generateMarkdown(child, folder, folderName, level + 1);
                    }
                }

                return markdown;
            }

            // Obtiene un nombre de archivo seguro para usar en rutas
            getSafeFileName(fileName) {
                const extension = fileName.split('.').pop();
                const baseName = fileName.slice(0, fileName.lastIndexOf('.'));
                const safeBaseName = baseName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                return `${safeBaseName}_${Date.now()}.${extension}`;
            }

            // Configura los event listeners para los botones principales
            setupEventListeners() {
                document.getElementById('saveButton').addEventListener('click', () => this.save());
                document.getElementById('exportButton').addEventListener('click', () => this.exportToMarkdown());
                document.getElementById('resetButton').addEventListener('click', () => this.reset());
            }

            // Configura los tooltips de Bootstrap
            setupTooltips() {
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }
        }

        // Inicializa el mapa mental
        const mindMap = new MindMap();

        // Carga el mapa mental guardado (si existe)
        mindMap.load();
    </script>
</body>

</html>